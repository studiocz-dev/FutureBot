# Database Tables Explanation

**Last Updated:** January 2025  
**Bot Version:** FutureBot v1.0

---

## Overview

Your Supabase database has several tables, some actively used and some reserved for future features. This document explains each table's purpose, current usage, and whether it's necessary.

---

## Currently Active Tables

### 1. `symbols` Table
**Purpose:** Store all trading symbols (coin pairs) that the bot monitors.

**Status:** âœ… **ACTIVE - REQUIRED**

**Schema:**
```sql
- id (uuid, primary key)
- symbol (text) - e.g., "BTCUSDT"
- exchange (text) - e.g., "BINANCE_FUTURES"
- quote_asset (text) - e.g., "USDT"
- active (boolean) - whether symbol is currently monitored
- created_at (timestamp)
```

**Current Data:** 20 symbols (BTCUSDT, ETHUSDT, BNBUSDT, etc.)

**Why Necessary:**
- Stores symbol metadata and UUID references
- Referenced by foreign keys in `candles` and `signals` tables
- Bot auto-creates symbols when they don't exist
- **Cannot be removed** without breaking database relationships

**Maintenance:** No cleanup needed - symbol records are small and permanent.

---

### 2. `candles` Table
**Purpose:** Store historical OHLCV (Open, High, Low, Close, Volume) price data for each symbol and timeframe.

**Status:** âœ… **ACTIVE - REQUIRED**

**Schema:**
```sql
- id (uuid, primary key)
- symbol_id (uuid, foreign key to symbols)
- timeframe (text) - e.g., "15m"
- open_time (bigint) - candle start time in milliseconds
- close_time (bigint) - candle end time in milliseconds
- open, high, low, close (numeric) - price data
- volume (numeric) - trading volume
- quote_volume (numeric) - volume in quote asset
- trades (integer) - number of trades
- taker_buy_base, taker_buy_quote (numeric) - taker buy volumes
- json_raw (jsonb) - full raw candle data from Binance
- created_at (timestamp)
```

**Current Usage:**
- Bot fetches 500 candles per symbol/timeframe on startup
- WebSocket updates add new candles in real-time
- Signal generation reads the last 200-500 candles for analysis
- **Currently using only 15m timeframe** (changed from 15m, 1h, 4h)

**Data Volume:**
- 20 symbols Ã— 1 timeframe Ã— 500 candles = **10,000 candles** initially
- Grows by ~20 candles every 15 minutes (one per symbol)
- ~1,920 new candles per day
- **Can grow large over time** - this is why cleanup is important

**Why Necessary:**
- **CRITICAL** - Signal generation requires historical price data
- Wyckoff and Elliott Wave analysis need 200-500 candles minimum
- Without candles, bot cannot generate signals at all
- **Cannot be removed**

**Maintenance:**
- âœ… **Cleanup recommended** - use `>cleanup confirm` to delete candles older than 30 days
- Keep at least 30 days of data for analysis
- Typical database size: 50,000-100,000 candles (reasonable)

---

### 3. `signals` Table
**Purpose:** Store all trading signals generated by the bot.

**Status:** âœ… **ACTIVE - REQUIRED**

**Schema:**
```sql
- id (uuid, primary key)
- symbol_id (uuid, foreign key to symbols)
- timeframe (text) - e.g., "15m"
- signal_type (text) - "LONG" or "SHORT"
- entry_price (numeric) - recommended entry price
- stop_loss (numeric) - stop loss price
- take_profit (numeric) - first take profit target
- take_profit_2, take_profit_3 (numeric) - additional TP targets
- confidence (numeric) - signal confidence (0.0-1.0)
- wyckoff_phase (text) - detected Wyckoff phase
- elliott_wave_count (text) - detected Elliott Wave count
- indicators (jsonb) - supporting indicator data
- rationale (text) - signal reasoning
- status (text) - "PENDING", "ACTIVE", "COMPLETED", "CANCELLED"
- discord_message_id (text) - Discord message ID where signal was posted
- payload_json (jsonb) - full signal data
- created_at (timestamp)
```

**Current Usage:**
- Bot generates signals when confidence > 0.65
- Conflict prevention prevents duplicate signals within 1 hour
- Signals posted to Discord channel #trade-signal-v2-test
- **Used for >status and >signals commands**

**Data Volume:**
- ~5-20 signals per day (depends on market volatility)
- ~150-600 signals per month
- **Manageable growth** but cleanup still recommended

**Why Necessary:**
- **REQUIRED** - Stores bot's trading recommendations
- Historical record of all signals generated
- Used by Discord commands to show recent signals
- **Cannot be removed**

**Maintenance:**
- âœ… **Cleanup recommended** - use `>cleanup confirm` to delete signals older than 30 days
- Keep at least 30 days for recent history
- Very old signals (>6 months) have minimal value

---

## Currently Empty Tables (Future Features)

### 4. `backtests` Table
**Purpose:** Store results from systematic backtesting runs.

**Status:** âš ï¸ **INACTIVE - OPTIONAL**

**Why Empty:**
- Backtesting currently done via **manual Python scripts** (`test_backtest.py`)
- Results saved to **local files** (`BACKTEST_RESULTS.md`)
- **NOT** integrated with Discord bot commands
- No automated backtest scheduling

**Future Usage (if implemented):**
- Store backtest parameters (start date, end date, timeframe, confidence threshold)
- Store performance metrics (win rate, profit factor, total trades)
- Compare multiple backtest runs
- Trigger backtests via Discord command (e.g., `>backtest BTC 30d`)

**Schema (example):**
```sql
- id (uuid, primary key)
- symbol_id (uuid, foreign key)
- timeframe (text)
- start_date, end_date (timestamp)
- min_confidence (numeric)
- total_signals (integer)
- winning_signals, losing_signals (integer)
- win_rate (numeric)
- total_pnl (numeric)
- profit_factor (numeric)
- max_drawdown (numeric)
- parameters (jsonb) - additional backtest settings
- created_at (timestamp)
```

**Is It Necessary?**
- âŒ **NOT REQUIRED** for current bot operation
- âœ… **USEFUL** if you want historical backtest tracking
- âœ… **RECOMMENDED** if you plan to automate backtesting
- Can be safely ignored for now

**Recommendation:** Keep the table structure, but don't worry about it being empty unless you want to add automated backtesting features.

---

### 5. `signal_performance` Table
**Purpose:** Track actual outcomes of trading signals (TP hit, SL hit, etc.).

**Status:** âš ï¸ **INACTIVE - OPTIONAL**

**Why Empty:**
- **Bot generates signals only** - it does NOT execute trades
- No integration with actual trading accounts
- No position tracking or outcome monitoring
- Requires **additional development** to populate

**Future Usage (if implemented):**
- Track signal outcomes: "TP1_HIT", "TP2_HIT", "SL_HIT", "EXPIRED"
- Calculate actual profit/loss per signal
- Measure signal accuracy over time
- Build performance analytics dashboard
- **Requires price monitoring** after signal generation

**Schema (example):**
```sql
- id (uuid, primary key)
- signal_id (uuid, foreign key to signals)
- outcome (text) - "TP1_HIT", "TP2_HIT", "TP3_HIT", "SL_HIT", "EXPIRED", "PENDING"
- outcome_price (numeric) - price when outcome occurred
- outcome_time (timestamp) - when outcome occurred
- profit_loss_pct (numeric) - calculated P&L percentage
- profit_loss_usdt (numeric) - P&L in USDT (if position size known)
- hold_duration (interval) - time from signal to outcome
- created_at (timestamp)
```

**How to Populate (requires development):**
- Add a **signal tracker** that monitors price after signal generation
- Check if price hits TP1, TP2, TP3, or SL
- Record the outcome and timestamp
- Calculate P&L based on entry and exit prices
- Update signal status from "PENDING" to "COMPLETED"

**Is It Necessary?**
- âŒ **NOT REQUIRED** for signal generation
- âœ… **VERY USEFUL** for measuring bot accuracy
- âœ… **RECOMMENDED** if you want to track signal quality
- Provides data for improving signal confidence thresholds

**Recommendation:** Keep the table for future use. If you want signal tracking:
1. Build a background task that monitors open signals
2. Check price every 1-5 minutes
3. Detect TP/SL hits and record outcomes
4. Update `signals.status` and create `signal_performance` records

---

### 6. `user_subscriptions` Table
**Purpose:** Manage multi-user subscriptions and permissions.

**Status:** âš ï¸ **INACTIVE - OPTIONAL**

**Why Empty:**
- Bot currently operates in **single-server mode**
- No user-specific features or permissions
- All signals posted to **one Discord channel**
- No subscription tiers or user preferences

**Future Usage (if implemented):**
- Track which users have access to signals
- Implement subscription plans (free, premium, etc.)
- User preferences (favorite symbols, notification settings)
- Multi-server deployments with per-user configs
- Premium features (more signals, priority support)

**Schema (example):**
```sql
- id (uuid, primary key)
- discord_user_id (text) - Discord user ID
- discord_username (text) - Discord username
- subscription_tier (text) - "FREE", "PREMIUM", "ENTERPRISE"
- subscribed_symbols (text[]) - array of symbols user wants
- subscribed_timeframes (text[]) - array of timeframes
- notification_enabled (boolean)
- subscription_start (timestamp)
- subscription_end (timestamp) - NULL for permanent
- stripe_customer_id (text) - for payment processing
- created_at (timestamp)
```

**How to Use (requires development):**
- Add Discord commands like `>subscribe BTC`, `>unsubscribe ETH`
- Check user subscription before sending DMs
- Implement payment integration (Stripe, PayPal)
- Filter signals based on user preferences
- Send personalized notifications

**Is It Necessary?**
- âŒ **NOT REQUIRED** for current single-user operation
- âœ… **USEFUL** if you plan to monetize the bot
- âœ… **RECOMMENDED** for multi-user deployments
- Can be safely ignored for personal use

**Recommendation:** Keep the table for future scalability, but don't worry about it being empty unless you're building a subscription service.

---

## Additional Database Objects

### Views (Read-Only Query Helpers)

#### `v_recent_signals` View
**Purpose:** Pre-joined view combining signals with symbol names.

**Status:** âœ… **ACTIVE - USED**

**Why Useful:**
- Joins `signals` and `symbols` tables automatically
- Simplifies queries in Discord commands (`>status`, `>signals`)
- Returns signal data with human-readable symbol names
- **Currently used by bot**

**Query Example:**
```sql
SELECT * FROM v_recent_signals 
WHERE symbol = 'BTCUSDT' 
ORDER BY created_at DESC 
LIMIT 10;
```

**Recommendation:** Keep this view - it's used by the bot's `get_recent_signals()` method.

---

## Database Cleanup Strategy

### What to Clean

âœ… **Clean Up (Recommended):**
- `candles` older than **30 days** (use `>cleanup confirm`)
- `signals` older than **30 days** (use `>cleanup confirm`)

âŒ **Never Clean:**
- `symbols` - permanent reference data
- `backtests` - historical backtest results (when populated)
- `signal_performance` - historical accuracy data (when populated)
- `user_subscriptions` - user data (when populated)

### How to Clean

**Option 1: Discord Command (Recommended)**
```
>cleanup confirm
```
- Deletes candles and signals older than 30 days
- Returns statistics on deleted records
- Safe - preserves recent data

**Option 2: SQL Query (Advanced)**
```sql
-- Delete candles older than 30 days
DELETE FROM candles 
WHERE open_time < (EXTRACT(EPOCH FROM NOW() - INTERVAL '30 days') * 1000);

-- Delete signals older than 30 days
DELETE FROM signals 
WHERE created_at < NOW() - INTERVAL '30 days';
```

**Cleanup Schedule:**
- **Weekly:** Run `>cleanup confirm` to remove old data
- **Monthly:** Check database size in Supabase dashboard
- **Quarterly:** Review if cleanup retention (30 days) needs adjustment

---

## Table Necessity Summary

| Table | Status | Necessary? | Can Delete? | Cleanup Needed? |
|-------|--------|------------|-------------|-----------------|
| `symbols` | âœ… Active | âœ… Required | âŒ Never | âŒ No |
| `candles` | âœ… Active | âœ… Required | âŒ Never | âœ… Yes (30+ days) |
| `signals` | âœ… Active | âœ… Required | âŒ Never | âœ… Yes (30+ days) |
| `backtests` | âš ï¸ Empty | âšª Optional | âš ï¸ If unused | âŒ No |
| `signal_performance` | âš ï¸ Empty | âšª Optional | âš ï¸ If unused | âŒ No |
| `user_subscriptions` | âš ï¸ Empty | âšª Optional | âš ï¸ If unused | âŒ No |
| `v_recent_signals` | âœ… Active | âœ… Required | âŒ Never | N/A (view) |

---

## Recommendations

### For Current Operation (Signal Generation Only)
**Keep:**
- `symbols` âœ…
- `candles` âœ…
- `signals` âœ…
- `v_recent_signals` âœ…

**Ignore (but keep for future):**
- `backtests` (if you add automated backtesting later)
- `signal_performance` (if you add signal tracking later)
- `user_subscriptions` (if you add multi-user features later)

### For Future Enhancements

**To Enable Signal Tracking:**
1. Build price monitoring background task
2. Detect TP/SL hits
3. Populate `signal_performance` table
4. Add `>performance` Discord command to show stats

**To Enable Automated Backtesting:**
1. Add `>backtest <symbol> <days>` Discord command
2. Run backtest engine programmatically
3. Save results to `backtests` table
4. Show backtest history with `>backtests` command

**To Enable Multi-User Subscriptions:**
1. Add user registration (`>register`)
2. Add subscription management (`>subscribe`, `>unsubscribe`)
3. Filter signals based on user preferences
4. Send personalized DMs instead of channel posts
5. Add payment integration (Stripe)

---

## Database Size Considerations

### Current Usage (15m timeframe only, 20 symbols)
- **Candles:** ~1,920 new records per day
- **Signals:** ~5-20 new records per day
- **Monthly Growth:** ~60,000 candles + ~150-600 signals
- **Annual Growth (without cleanup):** ~700,000 candles + ~1,800-7,200 signals

### With Cleanup (30-day retention)
- **Candles:** ~57,600 records (stable)
- **Signals:** ~150-600 records (stable)
- **Database Size:** <100 MB (very manageable)

### Supabase Free Tier Limits
- **Database Size:** 500 MB
- **Rows:** No hard limit
- **API Requests:** 500,000/month
- **With cleanup, you're well within limits** âœ…

---

## Conclusion

**Required Tables:**
- `symbols`, `candles`, `signals`, `v_recent_signals`

**Optional Tables (keep for future):**
- `backtests`, `signal_performance`, `user_subscriptions`

**Empty tables are NOT a problem** - they're reserved for future features and don't consume significant resources.

**Cleanup is important** - Use `>cleanup confirm` weekly to prevent database bloat.

**You have a clean, efficient database structure** that supports current operations and allows for future expansion. ðŸŽ‰

---

**Questions?** Check the bot's health status with `>status` or review signal history with `>signals`.
